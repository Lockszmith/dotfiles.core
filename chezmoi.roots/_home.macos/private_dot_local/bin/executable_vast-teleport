#!/usr/bin/env bash

# Usage: ./vast-teleport get version [auto|major|<vMajor>]
# Example: ./latest_teleport_version.sh get major

set -e

SCRIPT_NAME="${0##*/}"
usage() {
    printf '%s\n' \
        'Utility script for connecting and managing teleport client for VAST CS' \
        '' \
        "  ${SCRIPT_NAME} <command>..." \
        '' \
        'Usage:' \
        "  login    Login to VAST's teleport server" \
        "  search   Search VAST's teleport connections" \
        "  ssh      Establish SSH connection through VAST's teleport instance" \
        '  launch   Connect via teleport, leveraging any session multiplexing' \
        '           solution that is available' \
        '  upgrade  Upgrade tsh to the latest aviable client matching our server' \
        "  get      Fetch information regarding teleport's client or server" \
        ''
    exit 2
}

usage-ssh() {
    printf '%s\n' \
	'SSH using Teleport with interactive selection and VAST-reasnoble defaults' \
	'' \
        "${SCRIPT_NAME} " \
        '' \
        'Usage:' \
        ''
    exit 2
}

usage-get() {
    printf '%s\n' \
        "Fetch information regarding teleport's client or server" \
        '' \
        "  ${SCRIPT_NAME} get <sub-command>..." \
        '' \
        'Usage:' \
        '  get version               same as running `tsh version`' \
        '  get version server        grabs the version of the server' \
        '  get version server major  grabs the major version of the server' \
        '  get version client 15     grabs the latest version of the client for major' \
        "  get version client auto   grab the latest version based on the server's major version" \
        '' \
        "  When using Gal Szkolnik's chezmoi envrionment, can be used to get the" \
        "  correct tsh version by running:" \
        '    eval "$('"$SCRIPT_NAME"' get version server major -) czx status"' \
        ''
    exit 2
}

usage-search() {
    printf '%s\n' \
        "Search VAST's teleport connections" \
        '' \
        "  [SILENT=1] [BATCH=1] [QUERY='query syntax'] ${SCRIPT_NAME} search [<options>] <search string>" \
        '' \
        'Usage:' \
        '  BATCH=1  env/prefix - skip fuzzy search (tv/fzf) UX' \
        '  SILENT=1 env/prefix - supress teleport prompts' \
        '  QUERY    env/prefix - tsh query syntax' \
        '  <search string>     - tsh --search syntax' \
        '' \
        'Description:' \
        '  Perform a search (after making sure user is logged in) on the VAST Data Teleport instance' \
        '  If a single value is returned, output it. If more results are presented, feed them into' \
        '  a fuzzy search UI (tv/fzf).' \
        '' \
        '  Can also be used to just generate lists using the BATCH=1 environment variable' \
        '' \
        'Examples:' \
        "  \$ BATCH=1 ${SCRIPT_NAME} search tesla # show all matches for tesla, without fuzzy search UI" \
        '  cluster_psnt=VAST-TESLA-AUS-1,hostname=aus08p1vstfs01-cn1-DO-NOT-LOGIN' \
        '  cluster_psnt=VA22374479,hostname=c-0-1' \
        '  cluster_psnt=VA22465472,hostname=c-0-1' \
        '' \
        "  ${SCRIPT_NAME} search tesla,472 # will connect to cluster_psnt=VA22465472,hostname=c-0-1" \
        '' \
        "  ${SCRIPT_NAME} search . # Will present complete list in fuzzy search UI" \
        ''
    exit 2
}

usage-launch() {
    printf '%s\n' \
        'Connect via teleport, leveraging any session multiplexing solution that '\
        'is available' \
        '' \
        "  ${SCRIPT_NAME} launch [<options>...] <destination>" \
        '' \
        'Options:' \
        '  --no-mux  no multiplexing, even if it exists' \
        '' \
        'Description:' \
        "  'launch' uses 'search' to locate a host, if a single match is found, it" \
        "  launches immedietly. If more than one option exists, a fuzzy search UI" \
        "  will be presented. " \
        "" \
        "  run '${SCRIPT_NAME} search [--help]' for more detail and example searches." \
        ''
    exit 2
}

get_server_version() {
    curl -s https://teleport.vastdata.com:3080/webapi/ping \
    | jq -r '.server_version'
}
get_server_major() {
    get_server_version | awk -F. '{print $1}'
}

get_latest_version_by_major() {
    local MAJOR="$1"
    curl -s "https://api.github.com/repos/gravitational/teleport/releases?per_page=100" \
    | jq -r ".[].tag_name" \
    | grep -E "^v${MAJOR}\." \
    | sort -V \
    | tail -n 1
}

_do_upgrade() {
    eval "$(_go_get_version_server_major -) CZ_EXTR=1 chezmoi apply --verbose --include externals $(command -v tsh)"
}

_go_get() {
    case $1 in
        version) shift; _go_get_version "${@}" ;;
        *)       usage-get ;;
    esac
}

_go_get_version() {
    case $1 in
        '')     tsh version ;;
        server) shift; _go_get_version_server "${@}" ;;
        client) shift; _go_get_version_client "${@}" ;;
        *)      usage-get ;;
    esac
}

_go_get_version_server() {
    case $1 in
        '')    get_server_version ;;
        major) shift; _go_get_version_server_major "${@}" ;;
        *)     usage-get ;;
    esac
}

_go_get_version_client() {
    case $1 in
        '')   usage-get ;;
        auto) get_latest_version_by_major "$(get_server_major)" ;;
        *)    get_latest_version_by_major "${@}" ;;
    esac
}

_go_get_version_server_major() {
    case $1 in
        '')  get_server_major ;;
        '-') printf 'TELEPORT_MAJOR=' && get_server_major ;;
        *)   usage-get ;;
    esac
}

is_cmd() { type -p -- "${@}" 2> /dev/null 1> /dev/null; }

_test_target() {
    local TARGET="${1:-${TARGET}}"
    [ "$(tsh ssh --no-relogin "${TARGET}" echo ok)" == "ok" ] || return $?
}

_do_search() {
    if [[ $# -eq 0 || "$1" == "--help" ]]; then
        usage-search
    fi

    local FZF="tv --no-preview"
    local BATCH="${BATCH:-}"
    if ! is_cmd tv; then
        if is_cmd fzf; then
            FZF="fzf --no-preview"
        else
            FZF=''
            BATCH=1
        fi
    fi
    local SILENT=${SILENT:-${BATCH:+1}}
    local SEARCH="$1"
    local SSHUSER="${2:-${SSHUSER}}"
    local QUERY="${QUERY:+--query=${QUERY}}"

    ${SILENT:+:} printf 'Searching for %s...' "$SEARCH" >&2

    OPTIONS="$(
        tsh ls ${QUERY} --format json --search "$SEARCH" | jq -r ' .[] | (
            if .metadata.labels.customer_name
            then "customer_name=" + .metadata.labels.customer_name + ","
            elif .metadata.labels.Customer
            then "Customer=" + .metadata.labels.Customer + ","
            else ""
            end)
            + "cluster_psnt=\(.metadata.labels.cluster_psnt),"
            + "hostname=\(.spec.hostname),"
            + "teleport.internal/resource-id=\(.metadata.labels["teleport.internal/resource-id"]),"
            + "name=\(.metadata.name)"
        '
    )"

    if [[ -z "$BATCH" && "${OPTIONS}" == *$'\n'* ]]; then
        SELECTED_RAW="$( tv --no-preview <<<"$OPTIONS" )"
    else
        SELECTED_RAW="$OPTIONS"
    fi

    if [[ -z "$SELECTED_RAW" ]]; then
        ${SILENT:+:} printf 'Aborted (empty response)\n' >&2
        exit 2
    else
        TESTED=0
        SELECTED="$(<<<"$SELECTED_RAW" awk -F',' '{ print $4 }' )"

        [ -z "$SSHUSER" ] || \
        if ! _test_target "$SSHUSER"@"${SELECTED}"; then
            _test_target "$SSHUSER"@"${RAW_SELECTED}" \
            && SELECTED="${RAW_SELECTED}" \
            && TESTED=1
        else
            TESTED=1
        fi
        [ "$TESTED" != 1 ] || SELECTED="${SSHUSER}@${SELECTED}"
    fi

    ${SILENT:+:} printf '\n%s selected.\n' "$SELECTED_RAW" >&2
    echo "$SELECTED"
}

_do_login() {
    tsh login
}

_do_ssh() {
    local ECHO=${ECHO:-:}
    local SEARCH="$1"
    local SSHUSER="${SSHUSER:-}"

    local TARGET="${TARGET:-${SSHUSER:+${SSHUSER}@}$(_do_search "$SEARCH" "$SSHUSER")}"
    local MUX_THIS="${MUX_THIS:-0}"

    local RUN="${RUN:-}"
    if [[ -z "$RUN" && "$MUX_THIS" != "0" ]]; then
        local MUX_NAME="${TUNNEL:+${TUNNEL}>}${TARGET}|${SEARCH}|${SCRIPT_NAME}"
        if [[ "$MUX_THIS" == "1" ]]; then
            if [[ -n "$(command -v zellij)" ]]; then
                MUX_THIS="zellij run --floating --pinned 'true' --name '\${MUX_NAME}' --"
            elif [[ -n "$(command -v tmux)" ]]; then
                # TODO: Define tmux muxing cli
                MUX_THIS=""
            else
                MUX_THIS=""
            fi
        fi
        eval "RUN=\"${MUX_THIS}\""
    fi
    local TUNNEL="${TUNNEL:+-L ${TUNNEL}}"

    local MSG="Connecting to ${TARGET}"
    [ -z "${TUNNEL}" ] || MSG="${MSG}, with tunnel (${TUNNEL})"
    [ $# -lt 2 ] || MSG="${MSG}, running \`${*:2}\`"
    MSG="${MSG}..."
    printf "%s\n" "$MSG"

    eval "${RUN} tsh ssh --no-relogin ${SSH_OPTS} ${TUNNEL} '${TARGET}' ${*:2}"
}

_do_ssh_with_tunnel() {
    local ECHO=${ECHO:-:}
    local SEARCH="$1"
    local SSHUSER="${SSHUSER:-}"
    local SSH_OPTS="${SSH_OPTS:-}"

    local LOCAL_PORT="${LOCAL_PORT:-8443}"
    local TARGET_PORT="${TARGET_PORT:-443}"

    local VMS="${VMS:-"$(tsh ssh --no-relogin "${TARGET}" -- cat /vast/vman/mgmt-vip)"}"
    local TUNNEL="${LOCAL_PORT}:${VMS}:${TARGET_PORT}"

    local MUX_THIS="${MUX_THIS:-0}"
    local RUN="${RUN:-}"

    [[ $# -gt 1 ]] || SSH_OPTS="${SSH_OPTS:--N}"

    ECHO="${ECHO}" SSHUSER="${SSHUSER}" SSH_OPTS="${SSH_OPTS}" TARGET="${TARGET}" TUNNEL="${TUNNEL}" MUX_THIS="${MUX_THIS}" RUN="${RUN}" _do_ssh "$@"
}

_old_do_ssh_with_tunnel() {
    local ECHO=${ECHO:-:}
    local SEARCH="$1"
    local SSHUSER="${SSHUSER:-vastdata}"
    local LOCAL_PORT="${LOCAL_PORT:-8443}"
    local TARGET_PORT="${TARGET_PORT:-443}"

    local MUX_THIS="${MUX_THIS:-0}"
    local RUN="${RUN:-}"

    local VMS="${VMS:-"$(tsh ssh --no-relogin "${TARGET}" -- cat /vast/vman/mgmt-vip)"}"
    local TUNNEL="${LOCAL_PORT}:${VMS}:${TARGET_PORT}"

    if [[ -z "$RUN" && -n "$(command -v zellij)" ]]; then
        RUN="zellij run --floating --pinned 'true' --name '${TUNNEL}|${TARGET}|${SEARCH}|${SCRIPT_NAME}' --"
    fi

    TUNNEL="-L ${LOCAL_PORT}:${VMS}:${TARGET_PORT}"
    local SSH_OPTS="${SSH_OPTS:--N}"

    $ECHO "Creating tunnel (${TUNNEL}) to ${TARGET}..."
    printf "Executing: %s ...\n" "tsh ssh --no-relogin ${TUNNEL} ${TARGET} ${*:2}" >&2
    eval "${RUN} tsh ssh --no-relogin ${SSH_OPTS} ${TUNNEL} '${TARGET}' ${*:2}"
}

_go_launch() {
    local SRCH=() NO_MUX=0 DEST='' ECHO=':' LOGIN='_do_login'
    local ZELLIJ_DEST=/tmp/vast-teleport/zellij/teleport
    local SSHUSER="${SSHUSER:-vastdata}"
    [[ -n "$1" ]] || usage-launch
    while [[ -n "$1" ]]; do
        case $1 in
            '--help')           usage-launch ;;
            '--verbose')        ECHO=echo; set -x ;;
            '--no-login')       LOGIN=: ;;
            '--no-mux')         NO_MUX=1 ;;
            '--from-zellij')    FROM_ZELLIJ=1 ;;
            *)                  SRCH=( "${SRCH[@]}" "$1" $SSHUSER ) ;;
        esac
        shift
    done

    if [[ "$FROM_ZELLIJ" -eq 1 ]]; then
        LOGIN=:; NO_MUX=1;
        [ -r "$ZELLIJ_DEST" ] \
        || DEST="." \
        && DEST="$(env cat "$ZELLIJ_DEST")"
    fi

    $LOGIN
    DEST="${DEST:-$(_do_search "${SRCH[@]}")}"

    [[ -n "$DEST" ]] || exit 1
    [[ "$( wc -l <<<"$DEST" )" -eq 1 ]] || exit 1

    if [[ $NO_MUX != 1 ]] && is_cmd zellij; then
        mkdir -p "${ZELLIJ_DEST%/*}"
        echo "$DEST" > "${ZELLIJ_DEST}"
        zellij action new-tab --layout=teleport
    else
        if [[ "$FROM_ZELLIJ" -eq 1 ]]; then
            TARGET="${DEST}" MUX_THIS=1 _do_ssh_with_tunnel
        fi

        TARGET="${DEST}" _do_ssh
        ! [ -r "$ZELLIJ_DEST" ] || rm "$ZELLIJ_DEST"
    fi
}

_go() {
    while true; do
        case "$1" in
            --debug) shift; set -x; ;;
            login)   shift; _do_login "${@}"; break ;;
            upgrade) shift; _do_upgrade "${@}"; break ;;
            get)     shift; _go_get "${@}"; break ;;
            search)  shift; _do_search "${@}"; break ;;
            ssh)     shift; _do_ssh "${@}"; break ;;
            launch)  shift; _go_launch "${@}"; break ;;
            *)       usage ;;
        esac
    done
}

_go "${@}"

