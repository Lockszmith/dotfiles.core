#! /usr/bin/env bash

set -euo pipefail

is_cmd() { type -p -- "${@}" 2> /dev/null 1> /dev/null; }

cz-get-files () {
    local all_files

    all_files="$( cz get-all-files )"

    # If no args: just fuzzy-pick from all (multi-select)
    if [ "$#" -eq 0 ]; then
        if ! is_cmd tv >/dev/null 2>&1; then
            echo "Error: tv not found (needed for interactive fuzzy selection with no args)" >&2
            return 2
        else
            <<<"${all_files}" tv --preview-command="cat ~/'{1}' || stat ~/'{1}'"
            return 0
        fi
    fi

    # Process args
    local singles multi_candidates
    declare -a singles=()             # resolved to one match or passed as-is when no match
    declare -a multi_candidates=()    # accumulate ambiguous matches to fuzzy-pick from

    for arg in "$@"; do
        # Substring match (literal). Switch grep -F to -E if you want regex patterns.
        matches="$(<<<"$all_files" grep -E -- "^.: (.*/)?$arg\$" || true)"
        [ -n "$matches" ] || matches="$(<<<"$all_files" grep -E -- "^.: .*$arg.*\$" || true)"
        if [ -z "$matches" ]; then
            # No match at all: pass arg as-is
            singles+=("$arg")
        else
            count=$(printf "%s\n" "$matches" | wc -l | tr -d '[:space:]')
            if [ "$count" -eq 1 ]; then
                singles+=("$matches")
            else
                multi_candidates+=("$arg")
            fi
        fi
    done

    # If there are ambiguous matches, fuzzy-pick from their unique set
    declare -a picked=()
    if [ "${#multi_candidates[@]}" -gt 0 ]; then
        if ! is_cmd tv >/dev/null 2>&1; then
            echo "Error: tv not found (needed for disambiguating multiple matches)" >&2
            # Still output the resolved singles even if we cannot disambiguate
            printf "%s\n" "${singles[@]}" | uniq
            return 3
        fi
        # Let user multi-select with fzf (empty selection allowed)
        while IFS= read -r arg; do
            <<<"$all_files" \
            tv --input-prompt="'$arg'?> " --preview-command="cat ~/'{1}'" --input="$arg" \
            || true
        done <<<"$(printf "%s\n" "${multi_candidates[@]}" | uniq )"
    fi

    # Combine singles + picked, make unique, and output
    printf "%s\n" "${singles[@]}" "${picked[@]}" | uniq
}

__cz_edit() {
    local FILES="$(cz-get-files "${@}")"
    [ -n "$FILES" ] \
    && ${VISUAL:-${EDITOR:-vi}} $(<<<"$FILES" cz smart-path) \
    && (${CZA:-env} chezmoi apply --interactive $(<<<"$FILES" sed -Ee 's|^.: |~/|'))
}

cz() {
    ${SET_X:-:} -x
    case "$1" in
        apply) ${CZA:-env} chezmoi apply "${2---less-interactive}" "${@:3}"  ;;
        re-add) ${CZA:-env} chezmoi re-add "${2---less-interactive}" "${@:3}"  ;;
        *)
            if declare -f "__cz_${1}" > /dev/null; then
                __cz_${1} "${@:2}"
            elif is_cmd "cz-$1"; then
                cz-$1 "${@:2}"
            elif is_cmd "chezmoi-$1"; then
                chezmoi-$1 "${@:2}"
            else
                env chezmoi "${@}"
            fi
            ;;
    esac
    ${SET_X:-:} +x
}

cz "${@}"

# vim: set ft=sh sw=4 sts=4 et:
