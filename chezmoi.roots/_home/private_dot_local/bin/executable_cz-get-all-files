#! /usr/bin/env bash

set -euo pipefail

PREFIXED=0

get-cz-managed() {
    SET_X=: cz managed --exclude=remove,dirs,externals || true
}
get-cz-unmanaged() {
#   cz unmanaged --include=dirs | sed -Ee 's|$|/|;'
    SET_X=:
    comm -3 -1 <(get-cz-externals) <(
        cz unmanaged --exclude=dirs \
           | grep -Ev '\.zwc$' \
           | sort
   )
}
get-cz-git() {
    cz git  -- ls-files ${@}
}

get-cz-externals() {
    local cache="$HOME/.cache/chezmoi/managed.externals"
    if [ "${1:-}" = "--force" ] || ! [ -r "$cache" ]; then
        local tmp="$(mktemp)"
        printf 'Updating Externals cached list...' >&2
        env chezmoi managed --include externals | sort > "$tmp" && mv "$tmp" "$cache"
        printf 'Done\n' >&2
    fi

    command cat "$cache"
}

get-group() {
    local sedCode="| sed -Ee 's/^/${2:-?}: /'"
    [ -n "$2" ] || [ "$PREFIXED" = 1 ] || sedCode=""
    [ -z "$sedCode" ] || PREFIXED=1
    eval "$1 $sedCode"
}

get-all() {
    local sets=()
    while [ -n "${1:-}" ]; do
        case "$1" in
            "all" ) sets=(managed unmanaged) ;;
            "refresh-cache") get-cz-externals --force ;;
            * )
                    sets+=("$1") ;;
        esac
        shift
    done

    local sU=''
    if [ "${#sets[@]}" -eq 1 ]; then
        eval "get-cz-${sets}"
    else
        ( for s in "${sets[@]}"; do
            sU=${s:0:1}
            get-group "get-cz-$s" ${sU^}
        done ) | sort -Vk'2,2'
    fi

}

${SET_X:-:} -x
get-all "${@:-all}" | ( [ "$PREFIXED" = 0 ] && cat - || sort -Vk'2,2' )
${SET_X:-:} +x
# vim: set ft=sh sw=4 sts=4 et:
