{{- if has "with-atuin" (splitList " " (dig "sz" "env" "flags" "" .)) -}}
#!/usr/bin/env -S bash -c 'echo "Not a user script. source(aka .) only"'

if is_cmd atuin; then

    # -- Atuin daemon management
    # On ZFS filesystems, we need to use Atuin's daemon mode to avoid the SQLite/ZFS 
    # performance bug (https://github.com/atuinsh/atuin/issues/952).
    # If the Atuin daemon process is running, we point to a ZFS-specific
    # config that has daemon=true enabled. This ensures that all Atuin commands
    # communicate with the running daemon rather than attempting direct database access.
    # The setup-atuin-daemon.sh script should be run on ZFS systems to create and 
    # start the systemd service for the daemon.
    if pgrep -f "atuin daemon" > /dev/null && [ -d "$HOME/.config/atuin/with-daemon" ]; then
        export ATUIN_CONFIG_DIR="$HOME/.config/atuin/with-daemon"
    fi

    [[ -n "${DBG}" ]] && echo "atuin loaded."
fi

# vim: set ft=sh expandtab tabstop=4 shiftwidth=4:
{{- end }}
