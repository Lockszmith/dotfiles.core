#!/usr/bin/env -S bash -c 'echo "Not a user script. source(aka .) only"'

if is_cmd zoxide; then

    . <( zoxide init --cmd cd "${BASE_SHELL}" )

    [[ -n "${DBG}" ]] && echo "zoxide loaded."

fi

# Wheather zoxide has loaded or not, modify the behavior of 'cd' to allow
# passing a file as an argument, which will cd into the parent dir.

# --- Step 1: Clone the existing 'cd' function ---

# The 'declare -f cd' command outputs the function definition. We use sed to replace 
# the function name 'cd' with '__cd_pre_sz' and then eval to execute and define the new function.
# This ensures the original content of 'cd' is perfectly preserved inside '__cd_pre_sz'.
if declare -f cd >/dev/null 2>&1; then
    # Clone the current 'cd' function definition into '__cd_pre_sz'
    eval "$(declare -f cd | sed '1s/cd/__cd_pre_sz/')"
else
    # Fallback: If 'cd' was not a function (e.g., if it's the built-in command), 
    # we define a new wrapper that calls the built-in 'cd'. This makes no assumptions
    # about zoxide or any other wrapper.
    __cd_pre_sz () {
        builtin cd "$@"
    }
fi

# --- Step 2: Redefine the 'cd' function with pre-processing logic ---
cd () {
    # Check if an argument was provided AND if it is a regular file (-f).
    if [[ -n "$1" ]] && [[ -f "$1" ]]; then
        # Get the parent directory of the file path.
        # Using '--' protects against paths starting with dashes.
        local parent_dir
        parent_dir="$(dirname -- "$1")"

        printf "filename provided, performing cd to parent dir: %s\n" "$parent_dir" >&2

        # Redefine the function's positional parameters ($@): 
        # $1 becomes the calculated parent directory.
        # ${@:2} includes $2, $3, etc.
        set -- "$parent_dir" "${@:2}"
    fi

    # Now, call the renamed original function, passing the potentially modified arguments.
    # This executes the original logic that was preserved in '__cd_pre_sz'.
    __cd_pre_sz "$@"
}

# vim: set ft=sh expandtab tabstop=4 shiftwidth=4:

